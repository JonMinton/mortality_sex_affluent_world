---
title: "three_components_figures"
author: "Jon Minton"
date: "18 September 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction 

The purpose of this document is to present a series of figures which show how the different components of mortality and mortality difference by sex have changed over time. 

The three main components of the age-mortality schedule are:

1. Infantile
2. 'Accidental' 
3. Senescent

The aim of the figures below will be to get a better sense of how each of these three components have changed over time, and how differences in these changes over time have contributed to overall differences in both age specific mortality risk and life expectancy by sex. 


# Setting up the code 

```{r setup}

# Modelling 

# Replication and updating of Rigby & Dorling 2007, Mortality in relation to sex in the affluent world

# Updating using new country selection but ensuring same countries are not included twice


rm(list=ls())

# Prerequisite packages ---------------------------------------------------


pacman::p_load(
  MASS,
  readxl,
  tidyverse,
  grid, ggplot2,
  lattice, 
  latticeExtra
)




# Data --------------------------------------------------------------------


dta <- read_csv("data/counts.csv")


code_to_country_lookup <- read_excel(
  "support/replication_details.xlsx",
  sheet="code_to_country_lookup"
)

full_country_lookup <- code_to_country_lookup  %>% 
  filter(include_in_full_selection == 1)  %>% 
  .$code


# Original Table 1 : Country, years available, population in (say) 2010 or latest available year



# Derived data ------------------------------------------------------------



dta_selection <- dta %>% 
  filter(sex !="total" & country %in% full_country_lookup) %>% 
  group_by(year, age, sex) %>% 
  summarise(
    population_count = sum(population_count), 
    death_count = sum(death_count)
  ) %>% 
  filter(year >= 1850 & year <=2010)



dta_ratios <- dta_selection %>% 
  mutate(death_rate = death_count / population_count) %>% 
  select(year, age, sex, death_rate) %>% 
  spread(key=sex, value = death_rate) %>% 
  mutate(sex_ratio = male/ female) %>% 
  select(year, age , sex_ratio) %>% 
  filter(age <= 100)

fn <- function(x){
  smoothed_ratio <- rep(1, 101)
  for (i in 3:98){
    smoothed_ratio[i] <- prod(x$sex_ratio[(i-2):(i+2)]) ^ (1/5)
  }
  smoothed_ratio[-1] <- smoothed_ratio[-1]/smoothed_ratio[-101]
  out <- data.frame(x, smoothed_ratio = smoothed_ratio)
  return(out)
}


dta_ratios_fd <- dta_ratios %>% 
  group_by(year) %>% 
  do(fn(.)) 

```


# Produce curves by year, 1850 to 1910

```{r curves_by_year_1850_1910}

# Curves by year, fd, 1850 to 1910

avg_smooth_old <- dta_ratios_fd %>% 
  filter(year <= 1910) %>% 
  filter(age >= 5, age <= 95) %>% 
  group_by(age) %>% 
  summarise(
    average_smooth = mean(smoothed_ratio),
    var_smooth = var(smoothed_ratio)
    )


dta_ratios_fd %>% 
  filter(year <= 1910) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(
    ., 
    aes(x = age, y = smoothed_ratio, group = year)     
    ) + 
  geom_line(alpha = 0.05) + 
  geom_hline(yintercept = 1) +
  scale_x_continuous(breaks = seq(5, 95, by = 5)) + 
  scale_y_continuous(limits = c(0.9, 1.2), breaks = seq(0.9, 1.2, by = 0.01)) + 
  ggtitle("Change in sex ratio by age, 1850-1910") + 
  geom_line(
    aes(x = age, y = average_smooth),
    inherit.aes = F,
    data = avg_smooth_old,
    size = 1.2, colour = "blue"
  )
```
This series of curves, and averages of series of curves, shows reasonable consistency in the ages over which sex mortality ratios both convegence and diverge. 

1. Firstly, after infancy there is steady convergence in sex mortality ratios in early childhood, from around the ages of three to 15 years.
2. Then, from around the age of 15 years onwards, sex mortality ratios then begin to diverge sharply again, with the fastest rate of divergence occuring around the ages of 18-19 years. 
3. After around the age of 22-23 there was then a subsequent partial convergence of sex mortality ratios, peaking around the age of 26 years, and continuing until slightly after the age of 30 years. This is very likely due to historically high risks of maternal mortality during childbirth. 
4. From around the age of 30 to 50 years, mortality sex ratios then further diverge again.
5. After around the age of 50 years mortality sex ratios are relatively small. 


Let's now look at the same but over the period 1950-2010


```{r curves_by_year_1950_2010}
# Now the same over the period 1950-2010

avg_smooth_new <- dta_ratios_fd %>% 
  filter(year >= 1950, year <= 2010) %>% 
  filter(age >= 5, age <= 95) %>% 
  group_by(age) %>% 
  summarise(
    average_smooth = mean(smoothed_ratio),
    var_smooth = var(smoothed_ratio)
  )


dta_ratios_fd %>% 
  filter(year >= 1950, year <= 2010) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(
    ., 
    aes(x = age, y = smoothed_ratio, group = year)     
  ) + 
  geom_line(alpha = 0.05) + 
  geom_hline(yintercept = 1) +
  scale_x_continuous(breaks = seq(5, 95, by = 5)) + 
  scale_y_continuous(limits = c(0.9, 1.2), breaks = seq(0.9, 1.2, by = 0.01)) + 
  ggtitle("Change in sex ratio by age, 1950-2010") + 
  geom_line(
    aes(x = age, y = average_smooth),
    inherit.aes = F,
    data = avg_smooth_new,
    size = 1.2, colour = "red"
  )

```

Over this latter period there is a qualitatively different pattern of sex mortality differences 

1. There is no longer a convergence in ratios in early childhood. Instead sex mortality differences increase with the first few years of age, but at rates that gradually decrease up until around the age of 10 years.
2. From around the age of 10 years there is then a further divergence in rates, which then accelerates further from around the age of 13 years. The acceleration of this divergence then peaks at a slightly earlier age to before, at around 16 years, then slows down up to around the age of 23 years. 
3. There is then a slower but more sustained convergence in mortality rates from around the age of 23 years up to around 50 years, likely due to much lower rates of maternal mortality. 
4. Therer is then further convergence after around the age of 60 years, with the fastest rates of catch-up occurring in early elderly years and likely after retirement. 


The two average trends are shown together on the following figure 


```{r show_both_curves}
# Two averages on same figure

average_two_epochs <- bind_rows(
  avg_smooth_old %>% mutate(epoch = "old"),
  avg_smooth_new %>% mutate(epoch = "new")
) 

ggplot(
  average_two_epochs,
  aes(x = age, y = average_smooth, group = epoch, colour = epoch)
  ) + 
  geom_line(size = 1.2) + 
  geom_hline(yintercept = 1) +
  scale_x_continuous(breaks = seq(5, 95, by = 5)) + 
  scale_y_continuous(limits = c(0.9, 1.2), breaks = seq(0.9, 1.2, by = 0.01)) + 
  ggtitle("Average change in sex ratios over two epochs")  

```


We can also see the standard deviation of change within individual years in the two epochs as follows:

```{r show_stdev_curves}
# Variance of change with age by year within the two epochs

ggplot(
  average_two_epochs,
  aes(x = age, y = var_smooth^0.5, group = epoch, colour = epoch)
) + 
  geom_line(size = 1.2) + 
  scale_x_continuous(breaks = seq(5, 95, by = 5)) + 
#  scale_y_continuous(limits = c(0.9, 1.2), breaks = seq(0.9, 1.2, by = 0.01)) + 
  ggtitle("Standard deviation of age-change in sex ratios over two epochs")  

```

This suggests that the variation over the years is greatest in early adulthood, around the age of 18, and surprisingly is of almost identical magnitude in difference in log mortality in both epochs. There are likely to be wide variations in the conditions of the labour market which people are first exposed to when reaching adulthood. 
There is also wide variation between years in the magnitude of change in sex ratio with age, in the historic period around the age of around 23 and 30 years. It may be that some years were much more hazardous to give birth than others, possibly due to higher rates of infectious disease some years than others. 
Within the new epoch, variation between periods tends to remain fairly high until around the age of 57, before falling fairly sharply then continuing to fall at older ages. This again suggests that exposure to different labour market conditions may be a very important factor in age-specific sex mortality differences from one year to the next in the latter period. Once people retire we can expect the environmental conditions of males and females to become more alike. 

```{r curve_by_period}
# Explore curves by period ------------------------------------------------

dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(decade = cut(
    year, seq(1850, 2010, by = 10), 
    include.lowest = T,
    labels = paste0(seq(1850, 2000, by = 10), "s")
    )
  ) %>% 
  ggplot(., aes(x = age, y = lmr, group = sex, colour = sex)) + 
  geom_point(alpha = 0.1) + 
  facet_wrap(~decade)

```
As might be expected, the greatest variation in ASMRs within any years in each decade tends to be in those decades that include period of war, such as the 1910s, the 1930s and the 1940s. This variation is most obvious in young adult male mortality change. 

Another important thing to note is that log ASMRs differences tend to be greatest in early adulthood, and also have been tending to increase since the 1940s. 

Additionally, the senescent mortality pattern, apparent as a log-linear mortality schedule with age, is clearer for females than males in the latter decades. For males, it appears there may be a discontinuity in this scheduce, with perhaps one gradient between around ages 60+, and a slightly shallower gradient present between around the ages of 40 and 60 years. 

Let's now look at how these different schedules contribute to changing excess lmrs over the lifecourse


```{r excess_lmr_decade}

# Explore excess in lmr by period

dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  select(year, age, sex, lmr) %>% 
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>% 
  mutate(male_excess = diff_lmr > 0) %>% 
  mutate(decade = cut(
    year, seq(1850, 2010, by = 10), 
    include.lowest = T,
    labels = paste0(seq(1850, 2000, by = 10), "s")
  )
  ) %>% 
  ggplot(., aes(x = age, y = diff_lmr, colour = male_excess)) + 
  geom_point(alpha = 0.1) + facet_wrap(~decade) +
  theme(legend.position = "none") + 
  coord_cartesian(ylim = c(-0.6, 0.6)) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = c(15, 18, 25, 35, 60), linetype = "dashed")

```

Within the figure above, points are coloured blue if male mortality exceeds female at that age, and red if female mortality exceeds male. Vertical dashed lines have also been added at the following ages: 15, 18, 25, and 30 years. 

From this we can see that, in the earlier epoch, female mortality rates tended to exceed male rates in childhood, and also in early adulthood (child-bearing years). By around 1890 this latter female excess had disappeared, and by around 1930 the earlier (childhood) excess had also disappeared, meaning male mortality now exceeds female mortality at almost every age except in the very old. 

The first two vertical lines, 15 and 18 years, appear informative as in the new epoch it tends to be over these ages that male excess log mortality increases most. It then peaks in early adulthood, around the age of 23 years, before falling up to around the age of 35 years. After this age male log excess mortality then remains roughly constant up to around the age of 60. It only tends to be after retirement age when log excess mortality tends to fall. 


An important consideration is whether there are important differences by bith cohort


```{r bathtub_by_cohort_points}

# Bathtubs by cohort 
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  filter(cohort %in% seq(1800, 1980, by = 10)) %>% 
  ggplot(., aes(x = age, y = lmr, colour = sex, shape = sex)) + 
  geom_point() + 
  facet_wrap(~cohort)
```

```{r bathtub_by_cohort_point_excess_faceted}
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  filter(cohort %in% seq(1800, 1980, by = 10)) %>%
  select(cohort, age, sex, lmr) %>% 
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>% 
  ggplot(., aes(x = age, y = diff_lmr)) + 
  geom_point() + 
  facet_wrap(~cohort) + 
  geom_hline(yintercept = 0)
```
# line version of above grouped rather than faceted


```{r bathtub_by_cohort_line_excess}
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  select(cohort, age, sex, lmr) %>%
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>%
  filter(age <= 90) %>% 
  ggplot(., aes(x = age, y = diff_lmr, group = cohort, alpha = cohort )) + 
  geom_line() + 
  geom_hline(yintercept = 0) + 
  scale_alpha_continuous(limits = c(1800, 1980), range = c(0, 1))

```


```{r cohort_coloured}
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  select(cohort, age, sex, lmr) %>%
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>%
  filter(age <= 90) %>% 
#  filter(cohort >= 1930) %>% 
  ggplot(., aes(x = age, y = diff_lmr, group = cohort, color = cohort)) + 
  geom_line() + 
  geom_hline(yintercept = 0) + 
#  scale_alpha_continuous(limits = c(1930, 1980), range = c(0, 1)) + 
  scale_color_distiller(palette = "Paired")
```
# Let's try but faceted by decade


```{r cohort_coloured_faceted_decade}
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  select(cohort, age, sex, lmr) %>%
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>%
  mutate(cohort_decade = 10 * cohort %/% 10) %>% 
  mutate(year_within_cohort = cohort - cohort_decade) %>% 
  filter(age <= 90) %>% 
  filter(cohort >= 1850, cohort <= 1999) %>% 
  ggplot(., aes(x = age, y = diff_lmr, group = cohort, color = factor(year_within_cohort))) + 
  geom_line() + 
  geom_hline(yintercept = 0) + 
  facet_wrap(~cohort_decade) + 
  #  scale_alpha_continuous(limits = c(1930, 1980), range = c(0, 1)) + 
  scale_color_brewer(palette = "Paired", name = "Year\nwithin\ncohort") +
  scale_x_continuous(limits = c(0, 90), breaks = seq(0, 90, by = 5)) + 
  scale_y_continuous(breaks = seq(-0.10, 0.60, by = 0.05)) +
  coord_cartesian(ylim = c(-0.1, 0.6)) + 
  labs(title = "Difference in log mortality by cohort", x = "Age in years", y = "Difference in log mortality")
```

This above figure is complex, but appears informative. It appears the change in the shape of excess lmr schedule occurred in the space of around one generation, increasing progressively in young/middle adulthood for cohorts born in the 1920s, continuing to become sharper and more prolonged for cohorts born in the 1930s (entering labour market in 1950s), then starting to stabilise for cohorts born in the 1940s. For cohorts born in the 1940s there was more annual variation in early childhood (5-10 years) than for later cohorts. For cohorts born after around 150 the excess lmr schedule tends to have remained fairly constant up to around the age of 17 years. 

However, the rate of subsequent convergence after the peak then tends to depend more on very specific cohort birth year membership. It converged faster with age for cohorts born between aroudn 1960 and 1970, and so far the schedule seems fairly constant for cohorts born in and after 1970. 


Now let's look at a similar visualisation, by by period rather than cohort 



```{r faceted_coloured_bathtubs_period}
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  select(year, age, sex, lmr) %>%
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>%
  mutate(decade = 10 * year %/% 10) %>% 
  mutate(year_within_decade = year - decade) %>% 
  filter(age <= 90) %>% 
  filter(year < 2010) %>% 
  ggplot(., aes(x = age, y = diff_lmr, group = year, color = factor(year_within_decade))) + 
  geom_line() + 
  geom_hline(yintercept = 0) + 
  facet_wrap(~decade) + 
  #  scale_alpha_continuous(limits = c(1930, 1980), range = c(0, 1)) + 
  scale_color_brewer(palette = "Paired", name = "Year\nwithin\ndecade") +
  scale_x_continuous(limits = c(0, 90), breaks = seq(0, 90, by = 5)) + 
  scale_y_continuous(breaks = seq(-0.10, 0.60, by = 0.05)) +
  coord_cartesian(ylim = c(-0.1, 0.6)) + 
  labs(title = "Difference in log mortality by period", x = "Age in years", y = "Difference in log mortality")

```

Again, this is a complex visualisation, but appears informative in a number of ways 

1. Firstly, the schedules appear more discontinuous with age in the latter deacdes, in particular during working age. For example, in the 1980s there was a discontinuity around the ages of 40-50 years, implying cohorts from 1940-1950, with gradually declining mortality excesses before this age and largly flat excesses after this age up until around 60 years. Combined with the less discontinuous schedules when arranged by cohort, the rolling discontinuities appear consistent with cohort effects.
2. There is also evidence of period-based change in young adulthood in the 1950s and 1950s, with incremental worsening in the log excesses at these age groups. 

It is between ages 12 and 23 that the excesses peak. Then it is between around the ages of 23 and (say) 50 when they converge again. Both the gradient of the jump and the subsequent fall could be either period or cohort mediated, or a combination of the two. 

Let's look at change in this younger age range, first by period 


```{r gradient_change_period_younger_adulthood}
# Interest in gradient of change between ages 12 and 23 years 

# First by period, then by cohort 

# Note: dots look better here than lines
# By period
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  select(year,age, sex, lmr) %>% 
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>% 
  group_by(year) %>% 
  arrange(age) %>% 
  mutate(grad_lmr = diff_lmr - lag(diff_lmr)) %>% 
  filter(age >= 3, age <= 50) %>% 
  mutate(decade = 10 * year %/% 10) %>% 
  mutate(year_within_decade = year - decade) %>% 
  filter(year < 2010) %>% 
  ggplot(., aes(x = age, y = grad_lmr, group = year, color = factor(year_within_decade))) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  facet_wrap(~decade) + 
  scale_color_brewer(palette = "Paired", name = "Year\nwithin\ndecade") +
  scale_x_continuous(limits = c(3, 50), breaks = seq(4, 50, by = 2)) + 
  scale_y_continuous(breaks = seq(-0.05, 0.15, by = 0.01)) +
  coord_cartesian(ylim = c(-0.05, 0.15)) + 
  labs(title = "Change in Difference in log mortality by period", x = "Age in years", y = "Difference in log mortality") 
```

And now by cohort. 

```{r gradient_change_by_cohort}

# By cohort
dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>%
  mutate(cohort = year - age) %>% 
  select(cohort,age, sex, lmr) %>% 
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>% 
  group_by(cohort) %>% 
  arrange(age) %>% 
  mutate(grad_lmr = diff_lmr - lag(diff_lmr)) %>% 
  filter(age >= 3, age <= 50) %>% 
  mutate(cohort_decade = 10 * cohort %/% 10) %>% 
  mutate(year_within_cohort = cohort - cohort_decade) %>% 
  filter(cohort < 2000) %>% 
  ggplot(., aes(x = age, y = grad_lmr, group = cohort, color = factor(year_within_cohort))) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  facet_wrap(~cohort_decade) + 
  scale_color_brewer(palette = "Paired", name = "Year\nwithin\ncohort") +
  scale_x_continuous(limits = c(3, 50), breaks = seq(4, 50, by = 2)) + 
  scale_y_continuous(breaks = seq(-0.05, 0.15, by = 0.01)) +
  coord_cartesian(ylim = c(-0.05, 0.15)) + 
  labs(title = "Change in Difference in log mortality by cohort", x = "Age in years", y = "Difference in log mortality") 

```


I'm not really sure there's a big distinction between the two types of output in terms of visual impression


# Piecewise models

To try to understand how the different components of the schedule over time, I'm now going to model both the intercepts and gradients of the schedule over different parts of the life coures 

```{r piecewise models}
# Piecewise models --------------------------------------------------------


# The purpose of this section is to construct the model segmented by 
# different ages in the life course 
# First this will be by year, then by cohort 
peek <- function(x) print(sample_n(x, 10))

mdls_by_period <- dta_selection %>% 
  ungroup()  %T>% peek %>% 
  mutate(
    age_group = cut(
      age, 
      breaks = c(0, 3, 11, 23, 35, 59, 90, Inf),
      labels = c(
        "0-3",
        "4-11",
        "12-23",
        "24-35",
        "36-59",
        "60-90",
        "older"
      ),
      include.lowest = T
    )
  ) %T>% peek %>%
  filter(age_group != "older") %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %T>% peek %>% 
  group_by(year, age_group, sex) %>% 
  nest() %T>% peek %>% 
  mutate(mdl = map(data, ~ lm(lmr ~ I(age - min(age)), data = .))) %>%
  mutate(
    intercept = map_dbl(mdl, ~ coefficients(.)[[1]]),
    gradient = map_dbl(mdl, ~ coefficients(.)[[2]]),
    fit = map_dbl(mdl, ~ summary(.)[["adj.r.squared"]])
  ) 
```

Now to visualise this


```{r piecewise_visualisation_01}
# Now to visualise 

ggplot(
  mdls_by_period,
  aes(y = intercept, x = gradient, colour = fit)
  ) + 
  geom_path() + 
  facet_grid(sex ~ age_group, scale = "free_x") + 
  scale_color_distiller(palette = "Paired") + 
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_text(
    aes(label = year), 
    colour = "black", 
    fontface = "bold",
    check_overlap = T,
    data = . %>% filter(year %in% seq(1850, 2000, by = 25))
    )


```

It is worth broadly defining those age groups over which the time trends have been broadly similar or dissimilar between sexes. 

The trends are broadly *similar* for these age groups

* **Infants (0-3)** : The intercept (infant mortality rate) was broadly the same for for much of the period 1850-1900, then started to fall in the 20th century. This fall has continued for both genders. The gradient fell too between around 1900 and 1925, and again slightly between around 1950 and 1975, but has largely remained constant since. 
* **Young children (4-11 years)** : The intercept fell somewhat linearly from around 1900 onwards. The magnitude started to approach zero over this period too, however, suggesting broadly flat - and very low - mortality risk for both genders over this age range. 

The trends are broadly *dissimilar* for these age groups:

* **Older children (12-23 years)** : Trends were similar between around 1850 and 1925, with a falling intercept of a similar rate for both genders. There was also a similar fall for both genders over the period 1925 and 1950, though the 2nd World War led to a jump away from this general trend for a few years, creating a 'loop' in the path for males not seen for females. Between 1950 and 1975 the inercept fell for both genders, though faster for females than males. There was then a somewhat more gradual fall in this intercept between 1975 and 2000s. The gradients became increasingly different from 1950 onwards, with broadly static gradients for females, and accelerating gradients for males. The gradient for both genders over this age range used to be around 0.04-0.05. By the 2000s it had increased slightly for females, from around 0.035 in 1975 to 0.05 in 2010; and it had increased from around 0.06 to 0.08 for males. 
* **Young Adults (24-35 years) ** : The model tends to have the poorest fit within this age range, perhaps because there is less of a time trend and mortality in this age range is more dependent on period-specific 'accident hump' based mortality. However the tendency has been for the intercept to fall steadily throughout the period, up to around 1975. There was a sharper fall in the intercept for females betwene 1950 and 1975 than for males. For both genders the gradient tends to have increaseds in this latter period, but more so for males than females. 
* **Older working age adults (36-59 years) ** : For females there has been a clear, linear, long term trend towards compressed mortality implied by the polygon path. The intercept has steadily fallen at a similar rate throughout most of the period 1900 to 1975, falling almost an order of magnitude over this period. While this has happened the gradient has steadily increased, leading the the compression of mortality risk at older ages. For males, there was a similar trend over the period from around 1900 to 1950, but whereas there was a further improvement between the years 1950 and 1975 for females, the mortality schedule within the age group has been largely fixed from 1950 onwards, with very little change in either intercept or gradient. 
* ** Elderly (60-90 years) ** : There has been a steadier fall in intercept and increase in gradient for females than for males, though qualitatively a similar story of reduced mortality risk combined with steeper positive gradient with age (greater senescence). 


We can see how similarities and differences in patterns contribute to changing excesses over time 


```{r show_piecewise_excesses}

# And now to visualise change 

mdls_by_period %>% 
  group_by(year, age_group) %>% 
  mutate(
    dif_intercept = intercept[sex == "male"] - intercept[sex == "female"],
    dif_gradient = gradient[sex == "male"] - gradient[sex == "female"],
    dif_fit = fit[sex == "male"] - fit[sex == "female"]
    ) %>%  
  ggplot(
    aes(y = dif_intercept, x = dif_gradient, colour = dif_fit)
  ) + 
  geom_path() + 
  facet_wrap( ~ age_group, scale = "free", nrow = 1) + 
  scale_color_gradient2(
    low = "red", mid = "grey", high = "blue",
    limits = c(-1, 1)
    ) + 
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_text(
    aes(label = year), 
    colour = "black", 
    fontface = "bold",
    check_overlap = T,
    data = . %>% filter(year %in% seq(1850, 2000, by = 50))
  )

```
# Now to do the same kind of exercise by cohort 

And again by cohort 

```{r stuff_by_cohort}
age_group_selector <- dta_selection %>% 
  ungroup()  %T>% peek %>% 
  mutate(
    age_group = cut(
      age, 
      breaks = c(0, 3, 11, 23, 35, 59, 90, Inf),
      labels = c(
        "0-3",
        "4-11",
        "12-23",
        "24-35",
        "36-59",
        "60-90",
        "older"
      ),
      include.lowest = T
    )
  ) %T>% peek %>%
  filter(age_group != "older") %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %T>% peek %>% 
  separate(
    age_group, into = c("first_age", "last_age"), 
    sep = "-", remove = F
  ) %>%
  mutate(first_age = as.numeric(first_age), 
         last_age = as.numeric(last_age)
  ) %>% 
  mutate(cohort = year - age) %>%
  select(cohort, age, sex, age_group, first_age, last_age) %>% 
  group_by(cohort, age_group) %>% 
  arrange(age) %>% 
  mutate(
    min_found_age = min(age),
    max_found_age = max(age)
  ) %>% 
  mutate(
    age_group_ok = first_age == min_found_age & last_age == max_found_age
  ) %>% 
  select(cohort, age_group, age_group_ok) %>% 
  distinct() %>% ungroup()




dta_for_cohort_models <- dta_selection %>% 
  ungroup()  %T>% peek %>% 
  mutate(
    age_group = cut(
      age, 
      breaks = c(0, 3, 11, 23, 35, 59, 90, Inf),
      labels = c(
        "0-3",
        "4-11",
        "12-23",
        "24-35",
        "36-59",
        "60-90",
        "older"
      ),
      include.lowest = T
    )
  ) %T>% peek %>%
  filter(age_group != "older") %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  left_join(age_group_selector) %>% 
  filter(age_group_ok) %>% 
  select(cohort, age, age_group, sex, death_count, population_count) %>% 
  arrange(cohort, age, sex) %>% 
  mutate(
    mr = (death_count + 0.5) / (population_count + 0.5),
    lmr = log(mr, 10)
  )

mdls_by_cohort <- dta_for_cohort_models %>% 
  group_by(cohort, age_group, sex) %>% 
  nest() %T>% peek %>% 
  mutate(mdl = map(data, ~ lm(lmr ~ I(age - min(age)), data = .))) %>%
  mutate(
    intercept = map_dbl(mdl, ~ coefficients(.)[[1]]),
    gradient = map_dbl(mdl, ~ coefficients(.)[[2]]),
    fit = map_dbl(mdl, ~ summary(.)[["adj.r.squared"]])
  ) 
```

```{r visualise_models_by_cohort}

ggplot(
  mdls_by_cohort,
  aes(y = intercept, x = gradient, colour = fit)
) + 
  geom_path() + 
  facet_grid(sex ~ age_group, scale = "free") + 
  scale_color_distiller(palette = "Paired") + 
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_text(
    aes(label = cohort), 
    colour = "black", 
    fontface = "bold",
    check_overlap = T,
    data = . %>% filter(cohort %in% seq(1750, 1975, by = 25))
  )
```

```{r cohort_mod_fig_2}

mdls_by_cohort %>% 
  group_by(cohort, age_group) %>% 
  mutate(
    dif_intercept = intercept[sex == "male"] - intercept[sex == "female"],
    dif_gradient = gradient[sex == "male"] - gradient[sex == "female"],
    dif_fit = fit[sex == "male"] - fit[sex == "female"]
  ) %>%  
  ggplot(
    aes(y = dif_intercept, x = dif_gradient, colour = dif_fit)
  ) + 
  geom_path() + 
  facet_wrap( ~ age_group, scale = "free", nrow = 1) + 
  scale_color_gradient2(
    low = "red", mid = "grey", high = "blue",
    limits = c(-1, 1)
  ) + 
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_text(
    aes(label = cohort), 
    colour = "black", 
    fontface = "bold",
    check_overlap = T,
    data = . %>% filter(cohort %in% seq(1750, 1975, by = 25))
  )
```


```{r cohort_fig_03}
mdls_by_cohort %>% 
  group_by(cohort, age_group) %>% 
  mutate(
    dif_intercept = intercept[sex == "male"] - intercept[sex == "female"],
    dif_gradient = gradient[sex == "male"] - gradient[sex == "female"],
    dif_fit = fit[sex == "male"] - fit[sex == "female"]
  ) %>%  
  ggplot(
    aes(y = dif_intercept, x = dif_gradient, colour = dif_fit)
  ) + 
  geom_path() + 
  facet_wrap( ~ age_group, nrow = 1) + 
  scale_color_gradient2(
    low = "red", mid = "grey", high = "blue",
    limits = c(-1, 1)
  ) + 
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_text(
    aes(label = cohort), 
    colour = "black", 
    fontface = "bold",
    check_overlap = T,
    data = . %>% filter(cohort %in% seq(1750, 1975, by = 25))
  )
```


# Freshish start

I want to think about this afresh again.

The main thing I want to do are characterise the three components 

1. Infantile
2. Accident Hump
3. Senescent

The easiest of these to characterise will be infantile, and the hardest accident. 

```{r chunk}

# Infantile 
# 
# infantile_component <- dta_selection %>% 
#   ungroup() %>% 
#   filter(age == 0)
# 
# accident_component <- dta_selection %>% 
#   ungroup() %>% 
#   filter(age >= 10, age <=44)
# 
# senescent_component <- dta_selection %>% 
#   ungroup() %>% 
#   filter(age >= 55, age <=95)

dta_selection %>% 
  mutate(death_rate = death_count / population_count) %>% 
  mutate(lmr = log(death_rate, 10)) %>% 
  arrange(year, sex, age) %>% 
  group_by(year, sex) %>% 
  mutate(
    lg1 = lag(lmr), 
    lg2 = lag(lmr, 2), 
    ld1 = lead(lmr, 1), 
    ld2 = lead(lmr, 2)
  ) %>% mutate(
    sm_lmr = (lmr +  lg1 + lg2 + ld1 + ld2) / 5,
    ch_sm_lmr = sm_lmr - lag(sm_lmr),
    ch2_sm_lmr = ch_sm_lmr - lag(ch_sm_lmr)
  ) %>% 
  select(year, age, sex, population_count, death_count, lmr, sm_lmr, ch_sm_lmr, ch2_sm_lmr) -> acc_curves

# Now, for each year, find the age with the highest smr 

acc_curves %>% 
  filter(year %in% seq(1850, 2000, by = 25)) %>% 
  arrange(year, age) %>% 
  select(year, age, sex, sm_lmr, ch_sm_lmr, ch2_sm_lmr) %>% 
  gather(key = "variable", "value", sm_lmr:ch2_sm_lmr) %>% 
  ggplot(aes(x = age, group = year, colour = factor(year), y = value)) +        
  facet_grid(variable~sex, scales = "free_y") + 
  geom_line() + scale_x_continuous(breaks = seq(5, 90, by = 5)) + 
  geom_hline(yintercept = 0)



```

I think the approach should be to back-project estimated mortality risk over the age range 5+ years based on mortality rate schedule from age 45-95 inclusive. This is somewhat closer to the approach from Riffe in their accident hump work. 



# Older material ----------------------------------------------------------




# Interest is in cohorts who entered the labour market after 1950

# This means cohorts born from 1930


dta_selection %>% 
  ungroup %>% 
  mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  mutate(cohort = year - age) %>% 
  filter(cohort %in% seq(1930, 1980, by = 2)) %>%
  select(cohort, age, sex, lmr) %>% 
  spread(sex, lmr) %>% 
  mutate(diff_lmr = male - female) %>% 
  group_by(cohort) %>% 
  mutate(max_diff = max(diff_lmr)) %>%
  mutate(age_max_diff = age[diff_lmr == max_diff]) %>% 
  mutate(age_selection = age >= age_max_diff) %>% 
  ungroup() %>% 
  ggplot(., aes(x = age, y = diff_lmr)) + 
  geom_point(alpha = 0.3) + 
  facet_wrap(~cohort) + 
  geom_hline(yintercept = 0) +
  stat_smooth(data = . %>% filter(age_selection == T), method = "lm", se = F) +
  stat_smooth(data = . %>% filter(age_selection == F), method = "lm", se = F, colour = "red")

# 
# # For each cohort want to extract the following:
# # maximum of three age average rate of change 
# # gradient from maximum age to last observed age 
# 
# calculate_params <- function(DTA){
#   # DTA contains age and diff
#   DTA <- DTA %>% 
#     arrange(age) %>% 
#     mutate(sm_diff_lmr = mean(c(lag(diff_lmr), diff_lmr, lead(diff_lmr)))) 
#   
#   max_diff <- max(DTA$sm_diff_lmr, na.rm = T)
#   age_max_diff <- DTA$age[DTA$sm_diff_lmr == max_diff]
#   
#   max_age <- max(DTA$age, na.rm = T)
#   
#   DTA_SS <- DTA %>% filter(age >= age_max_diff)
#   
#   mdl <- lm(diff_lmr ~ age, data = DTA_SS)
#   fall <- coefficients(mdl)[2]
#   
#   out <- list(age_max_diff, max_diff, fall)
#   out
# }
# 
# 
# dta_selection %>% 
#   ungroup %>% 
#   mutate(mr = (death_count + 0.5) / (population_count + 0.5)) %>% 
#   mutate(lmr = log(mr, 10)) %>% 
#   mutate(cohort = year - age) %>% 
#   select(cohort, age, sex, lmr) %>% 
#   spread(sex, lmr) %>% 
#   mutate(diff_lmr = male - female) %>% 
#   filter(cohort >= 1850) %>% 
#   group_by(cohort) %>% 
#   nest() %>% 
#   mutate(params = map(data, safely(calculate_params)))
# 
# 

# Want to look at change in smoothed derivative 

dta_ratios_fd %>% 
  ungroup() %>% 
  filter(year %in% seq(1850, 2010, by = 10)) %>% 
  filter(age >= 5, age <= 95) %>% 
  mutate(divergence = smoothed_ratio > 1) %>% 
  ggplot(., aes(x = age, y = smoothed_ratio, colour = divergence, shape = divergence)) + 
  geom_point() + 
  facet_wrap(~year) + 
  geom_hline(yintercept = 1)


# Now to look at this by cohort 

dta_ratios_fd %>% 
  ungroup() %>% 
  mutate(cohort = year - age) %>% 
  filter(cohort %in% seq(1800, 1980, by = 10)) %>% 
  mutate(divergence = smoothed_ratio > 1) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(., aes(x = age, y = smoothed_ratio, colour = divergence, shape = divergence)) + 
  geom_point() + 
  facet_wrap(~cohort) + 
  geom_hline(yintercept = 1)

dta_ratios_fd %>% 
  ungroup() %>% 
  mutate(cohort = year - age) %>% 
  filter(cohort %in% seq(1930, 1970, by = 2)) %>% 
  mutate(divergence = smoothed_ratio > 1) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(., aes(x = age, y = smoothed_ratio, colour = divergence, shape = divergence)) + 
  geom_point() + 
  facet_wrap(~cohort) + 
  geom_hline(yintercept = 1)


dta_ratios_fd %>% 
  ungroup() %>% 
  mutate(cohort = year - age) %>% 
  mutate(divergence = smoothed_ratio > 1) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(., aes(x = age, y = smoothed_ratio, colour = cohort, shape = divergence)) + 
  geom_jitter(alpha = 0.1) + 
  geom_hline(yintercept = 1) + 
  scale_color_distiller(type = "qual") + 
  coord_cartesian(ylim=c(0.8, 1.2))

dta_ratios_fd %>% 
  ungroup() %>% 
  mutate(divergence = smoothed_ratio > 1) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(., aes(x = age, y = smoothed_ratio, colour = year, shape = divergence)) + 
  geom_jitter(alpha = 0.1) + 
  geom_hline(yintercept = 1) + 
  scale_color_distiller(type = "qual") + 
  coord_cartesian(ylim=c(0.8, 1.2))

dta_ratios_fd %>% 
  ungroup() %>% 
  mutate(divergence = smoothed_ratio > 1) %>% 
  filter(age >= 5, age <= 95) %>% 
  ggplot(., aes(x = age, y = smoothed_ratio, colour = year, shape = divergence)) + 
  geom_jitter(alpha = 0.1) + 
  geom_hline(yintercept = 1) + 
  scale_color_distiller(type = "qual") + 
  coord_cartesian(ylim=c(0.8, 1.2)) 




dta_selection %>% 
  ungroup() %>%  
  mutate(
    death_count = round(death_count + 1, 0), 
    population_count = round(population_count + 1, 0)
  ) -> dta_for_nb

formulae <- c(
  sex    = "death_count ~ sex + offset(log(population_count))",
  s_a    = "death_count ~ I(age - min(age)) + sex + offset(log(population_count))",
  s_p    = "death_count ~ I(year - min(year)) + sex + offset(log(population_count))",
  s_c    = "death_count ~ I(cohort - min(cohort)) + sex + offset(log(population_count))", 
  s_a_p  = "death_count ~ I(age - min(age)) + I(year - min(year)) + sex + offset(log(population_count))",
  s_A    = "death_count ~ factor(age) + sex + offset(log(population_count))",
  s_P    = "death_count ~ factor(year) + sex + offset(log(population_count))",
  s_C    = "death_count ~ factor(cohort) + sex + offset(log(population_count))"
)

glm.nb(
  death_count ~ sex + offset(log(population_count)),
  data = dta_for_nb
)

glm.nb(
  death_count ~ sex,
  offset = log(population_count),
  data = dta_for_nb
)



# Segmentation analysis ---------------------------------------------------


# Idea - look at gradient and intercept for log mort for males 
# and females and see how this has changed over time 

# do this for the age range 60-95 to start with 

dta_selection %>% 
  ungroup %>% 
  mutate(mr = death_count / population_count) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  filter(age >= 60, age <= 95) %>% 
  group_by(sex, year) %>% 
  nest() %>% 
  mutate(
    mdl = map(data, ~ lm(lmr ~ I(age - min(age)), .))
  ) %>% 
  mutate(
    coef = map(mdl, coef)
  ) %>% 
  mutate(
    intercept = map_dbl(coef, ~ .[[1]]),
    gradient = map_dbl(coef, ~ .[[2]])
  ) -> mdl_old 

mdl_old %>% 
  ggplot(., aes(x = intercept, y = gradient, colour = sex)) +
  geom_point(aes(alpha = year, shape = sex)) + 
  geom_label(aes(label = year), data = . %>% filter(year %in% seq(1850, 2000, by = 25)))


dta_selection %>% 
  ungroup %>% 
  mutate(mr = death_count / population_count) %>% 
  mutate(lmr = log(mr, 10)) %>% 
  filter(age >= 40, age <= 60) %>% 
  group_by(sex, year) %>% 
  nest() %>% 
  mutate(
    mdl = map(data, ~ lm(lmr ~ I(age - min(age)), .))
  ) %>% 
  mutate(
    coef = map(mdl, coef)
  ) %>% 
  mutate(
    intercept = map_dbl(coef, ~ .[[1]]),
    gradient = map_dbl(coef, ~ .[[2]])
  ) -> mdl_middle

mdl_middle %>% 
  ggplot(., aes(x = intercept, y = gradient, colour = sex)) +
  geom_path(aes(alpha = year)) + 
  geom_label(aes(label = year), data = . %>% filter(year %in% seq(1850, 2000, by = 25)))


mdl_both <- bind_rows(
  mdl_middle %>% 
    select(sex, year, intercept, gradient) %>% 
    mutate(age_range = "middle"),

  mdl_old %>% 
    select(sex, year, intercept, gradient) %>% 
    mutate(age_range = "old")
)

mdl_both %>% 
  group_by(year, age_range) %>% 
  mutate(dif_intercept = intercept[sex == "male"] - intercept[sex == "female"]) %>% 
  mutate(dif_gradient = gradient[sex == "male"] - gradient[sex == "female"])  %>% 
  select(year, age_range, dif_intercept, dif_gradient) %>% 
  ungroup() %>% 
  distinct() %>% 
  ggplot(., aes(x = dif_intercept, y = dif_gradient, colour = age_range, group= age_range)) + 
  geom_path(aes(alpha = year)) + 
  geom_label(aes(label = year), data = . %>% filter(year %in% seq(1850, 2000, by = 25))) +
  geom_hline(yintercept = 0) + geom_vline(xintercept = 0)



  



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
